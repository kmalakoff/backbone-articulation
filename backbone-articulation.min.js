// Generated by CoffeeScript 1.3.3

/*
  Backbone-Articulation.js 0.3.2
  (c) 2011, 2012 Kevin Malakoff.
  Backbone-Articulation may be freely distributed under the MIT license.
  https://github.com/kmalakoff/backbone-articulation
*/(function(){var Backbone,JSONS,LC,_,__hasProp={}.hasOwnProperty,__extends=function(child,parent){function ctor(){this.constructor=child}for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child};_=!this._&&typeof require!="undefined"?require("underscore"):this._,_&&!_.VERSION&&(_=_._),Backbone=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,JSONS=!this.JSONS&&typeof require!="undefined"?require("json-serialize"):this.JSONS,LC=!this.LC&&typeof require!="undefined"?require("lifecycle"):this.LC,Backbone.Articulation=typeof exports!="undefined"?exports:{},Backbone.Articulation.VERSION="0.3.2",Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE=!1,Backbone.Articulation._mixin=function(target_constructor,source_constructor,source_fns){var Link,fn,fns,name,_link_super;fns=_.pick(source_constructor.prototype,source_fns),_link_super=target_constructor.__super__.constructor,Link=function(_super){function Link(){this.__bba_super=_link_super,_.extend(this,fns),Link.__super__.constructor.apply(this,arguments)}return __extends(Link,_super),Link}(_link_super);for(name in fns)fn=fns[name],Link.prototype[name]=fn;return target_constructor.__super__=Link.prototype},Backbone.Articulation.Model=function(_super){function Model(){return Model.__super__.constructor.apply(this,arguments)}return __extends(Model,_super),Model.extend=Backbone.Model.extend,Model.prototype.__bba_super=Backbone.Model,Model.prototype.toJSON=function(){var class_name,json;json=JSONS.serialize(this.attributes,{properties:!0});if(json.hasOwnProperty(JSONS.TYPE_FIELD))return json;if(this.hasOwnProperty(JSONS.TYPE_FIELD))return json[JSONS.TYPE_FIELD]=this[JSONS.TYPE_FIELD],json;class_name=Object.getPrototypeOf(Object(this)).constructor.name;if(!class_name)return json;if(Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE){if(!String.prototype.underscore)throw"Missing String.prototype.underscore";if(!String.prototype.singularize)throw"Missing String.prototype.singularize";json[JSONS.TYPE_FIELD]=class_name.underscore().singularize()}else json[JSONS.TYPE_FIELD]=class_name;return json},Model.prototype.parse=function(resp,xhr){return resp?JSONS.deserialize(resp,{properties:!0,skip_type_field:!0}):resp},Model.prototype.set=function(attrs,options){var key,value;if(!attrs)return this;attrs.attributes&&(attrs=attrs.attributes);for(key in attrs){value=attrs[key];if(_.isEqual(this.attributes[key],value))continue;this._previousAttributes&&this._previousAttributes.hasOwnProperty(key)&&this._disownAttribute(key,this._previousAttributes[key]),this._ownAttribute(key,value)}return this.__bba_super.prototype.set.apply(this,arguments)},Model.prototype.unset=function(attr,options){return attr in this.attributes?(this._disownAttribute(attr,this.attributes[attr]),this.__bba_super.prototype.unset.apply(this,arguments)):this},Model.prototype.clear=function(options){var key;for(key in this.attributes)this._disownAttribute(key,this.attributes[key]);if(options&&options.silent)for(key in this._previousAttributes)this._disownAttribute(key,this._previousAttributes[key]);return this.__bba_super.prototype.clear.apply(this,arguments)},Model.prototype.change=function(options){var key,result;for(key in this._previousAttributes)this._disownAttribute(key,this._previousAttributes[key]);result=this.__bba_super.prototype.change.apply(this,arguments);for(key in this._previousAttributes)this._previousAttributes[key]=this._ownAttribute(key,this._previousAttributes[key]);return result},Model.prototype._ownAttribute=function(key,value){if(!value)return;return value instanceof Backbone.Model||value instanceof Backbone.Collection?value:_.isArray(value)&&value.length&&value[0]instanceof Backbone.Model||value[0]instanceof Backbone.Collection?value:LC.own(value)},Model.prototype._disownAllAttributes=function(){},Model.prototype._disownAttribute=function(key,value){if(!value)return;return value instanceof Backbone.Model||value instanceof Backbone.Collection?value:_.isArray(value)&&value.length&&value[0]instanceof Backbone.Model||value[0]instanceof Backbone.Collection?value:LC.disown(value)},Model.mixin=function(target_constructor){return Backbone.Articulation._mixin(target_constructor,Backbone.Articulation.Model,["toJSON","parse","set","unset","clear","change","_ownAttribute","_disownAttribute"])},Model}(Backbone.Model),Backbone.Articulation.Collection=function(_super){function Collection(){return Collection.__super__.constructor.apply(this,arguments)}return __extends(Collection,_super),Collection.extend=Backbone.Collection.extend,Collection.prototype.__bba_super=Backbone.Collection,Collection.prototype.model=Backbone.Articulation.Model,Collection.prototype.toJSON=function(){var model,models_as_JSON,_i,_len,_ref;models_as_JSON=[],_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++)model=_ref[_i],models_as_JSON.push(model.toJSON());return models_as_JSON},Collection.prototype.parse=function(resp,xhr){var articulated_model_attributes,model_resp,_i,_len;if(!resp||!_.isArray(resp))return resp;articulated_model_attributes=[];for(_i=0,_len=resp.length;_i<_len;_i++)model_resp=resp[_i],articulated_model_attributes.push(JSONS.deserialize(model_resp,{skip_type_field:!0}));return articulated_model_attributes},Collection.prototype._onModelEvent=function(event,model,collection,options){var key;if(event==="destroy"){for(key in model._previousAttributes)model._disownAttribute(key,model._previousAttributes[key]);for(key in model.attributes)model._disownAttribute(key,model.attributes[key])}return this.__bba_super.prototype._onModelEvent.apply(this,arguments)},Collection.prototype._removeReference=function(model){return model&&model.clear({silent:!0}),this.__bba_super.prototype._removeReference.apply(this,arguments)},Collection.mixin=function(target_constructor){return Backbone.Articulation._mixin(target_constructor,Backbone.Articulation.Collection,["toJSON","parse","_reset","_onModelEvent"])},Collection}(Backbone.Collection),typeof Backbone.RelationalModel!="undefined"&&(Backbone.Articulation.RelationalModel=Backbone.RelationalModel.extend({toJSON:function(){var index,json,model_json,rel,value,_i,_j,_len,_len1,_ref;if(this.isLocked())return this.id;this.acquire(),json=Backbone.Model.prototype.toJSON.call(this),_ref=this._relations;for(_i=0,_len=_ref.length;_i<_len;_i++){rel=_ref[_i],value=json[rel.key];if(rel.options.includeInJSON===!0&&value&&typeof value=="object")json[rel.key]=_.isFunction(value.toJSON)?value.toJSON():value;else if(_.isString(rel.options.includeInJSON))if(!value)json[rel.key]=null;else if(value instanceof Backbone.Collection)json[rel.key]=value.pluck(rel.options.includeInJSON);else if(value instanceof Backbone.Model)json[rel.key]=value.get(rel.options.includeInJSON);else if(_.isArray(value)){json[rel.key]=[];for(index=_j=0,_len1=value.length;_j<_len1;index=++_j)model_json=value[index],_.isUndefined(model_json)||json[rel.key].push(model_json[rel.options.includeInJSON])}else value instanceof Object&&(json[rel.key]=value[rel.options.includeInJSON]);else delete json[rel.key]}return this.release(),json},_reset:function(){var model,_i,_len,_ref;if(this.models){_ref=this.models;for(_i=0,_len=_ref.length;_i<_len;_i++)model=_ref[_i],Backbone.Relational.store.unregister(model)}return this.__bba_super.prototype._reset.apply(this,arguments)}}),Backbone.Articulation.Model.mixin(Backbone.Articulation.RelationalModel),Backbone.Articulation.RelationalCollection=Backbone.Articulation.Collection.extend({model:Backbone.Articulation.RelationalModel}),Backbone.Articulation.Collection.mixin(Backbone.Articulation.RelationalCollection))}).call(this);