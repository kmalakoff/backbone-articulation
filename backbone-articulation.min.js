// Backbone-Articulation.js 0.3.0
// (c) 2011 Kevin Malakoff.
// Backbone-Articulation may be freely distributed under the MIT license.
//
// JSON-Serialize.js 1.0.0
// (c) 2011 Kevin Malakoff.
// JSON-Serialize is freely distributable under the MIT license.
// https://github.com/kmalakoff/json-serialize
//
// Lifecycle.js 1.0.0
// (c) 2011 Kevin Malakoff.
// Lifecycle is freely distributable under the MIT license.
// https://github.com/kmalakoff/Lifecycle
//
(function(){this.JSON||(this.JSON={});JSON.SERIALIZE_VERSION="1.0.0";var b=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0};JSON.serialize=function(a){if(!a||typeof a!=="object")return a;if(a.toJSON)return a.toJSON();else if(b(a))return null;var d;if(a.constructor==Array){d=[];for(var e=0,g=a.length;e<g;e++)d.push(JSON.serialize(a[e]))}else for(e in d={},a)d[e]=JSON.serialize(a[e]);return d};JSON.deserialize=function(a,d){var e=typeof a;if(e==="string")if(a.length&&(a[0]==="{"||
a[0]==="["))try{var g=JSON.parse(a);g&&(a=g)}catch(k){throw new TypeError("Unable to parse JSON: "+a);}else if((!d||!d.skip_dates)&&a.length>=19&&a[4]=="-"&&a[7]=="-"&&a[10]=="T"&&a[a.length-1]=="Z")try{var f=new Date(a);if(f)return f}catch(m){}if(e!=="object"||b(a))return a;if(a.constructor==Array){for(var e=[],c=0,g=a.length;c<g;c++)e.push(JSON.deserialize(a[c]));return e}else if(d&&d.skip_type_field||!a.hasOwnProperty(JSON.deserialize.TYPE_FIELD)){e={};for(c in a)e[c]=JSON.deserialize(a[c]);return e}else{c=
a[JSON.deserialize.TYPE_FIELD];e=0;for(g=JSON.deserialize.CONSTRUCTOR_ROOTS.length;e<g;e++){f=JSON.deserialize.CONSTRUCTOR_ROOTS[e];a:{var h=f,i=c,f=i.split(".");if(f.length===1)f=h instanceof Object&&h.hasOwnProperty(i)?h[i]:void 0;else{for(var i=void 0,j=0,l=f.length;j<l;){i=f[j];if(!(i in h))break;if(++j===l){f=h[i];break a}h=h[i];if(!h||!(h instanceof Object))break}f=void 0}}if(f)if(f.fromJSON)return f.fromJSON(a);else if(f.prototype&&f.prototype.parse)return c=new f,c.set?c.set(c.parse(a)):c.parse(a)}return null}};
JSON.deserialize.TYPE_FIELD="_type";JSON.deserialize.CONSTRUCTOR_ROOTS=[this]})();
(function(){this.Lifecyle||(this.Lifecyle={});this.LC=this.Lifecyle;LC.VERSION="1.0.0";LC.own=function(b,a){if(!b||typeof b!="object")return b;a||(a={});if(b.constructor==Array){var d,e=b.length;if(a.share_collection)for(d=0;d<e;d++)LC.own(b[d],{prefer_clone:a.prefer_clone});else{var g=[];for(d=0;d<e;d++)g.push(LC.own(b[d],{prefer_clone:a.prefer_clone}));return g}}else if(a.properties)if(a.share_collection)for(key in b)LC.own(b[key],{prefer_clone:a.prefer_clone});else{d={};for(key in b)d[key]=LC.own(b[key],
{prefer_clone:a.prefer_clone});return d}else if(b.retain)if(a.prefer_clone&&b.clone)return b.clone();else b.retain();else if(b.clone)return b.clone();return b};LC.disown=function(b,a){if(!b||typeof b!="object")return b;a||(a={});if(b.constructor==Array){var d,e=b.length;if(a.clear_values)for(d=0;d<e;d++)LC.disown(b[d],{clear_values:a.clear_values}),b[d]=null;else{for(d=0;d<e;d++)LC.disown(b[d],{remove_values:a.remove_values});if(a.remove_values)b.length=0}}else if(a.properties)if(a.clear_values)for(d in b)LC.disown(b[d],
{clear_values:a.clear_values}),b[d]=null;else{for(d in b)LC.disown(b[d],{remove_values:a.remove_values});if(a.remove_values)for(d in b)delete b[d]}else b.release?b.release():b.destroy&&b.destroy();return b};LC.RefCountable=function(){function b(){this.ref_count=1}b.prototype.retain=function(){if(this.ref_count<=0)throw Error("LC.RefCounting: ref_count is corrupt: "+this.ref_count);this.ref_count++;return this};b.prototype.release=function(){if(this.ref_count<=0)throw Error("LC.RefCounting: ref_count is corrupt: "+
this.ref_count);this.ref_count--;this.ref_count===0&&this._destroy&&this._destroy.call(this);return this};b.prototype.refCount=function(){return this.ref_count};return b}()})();
(function(){_||alert("Missing Underscore.js");Backbone||alert("Missing Backbone.js");JSON.SERIALIZE_VERSION||alert("Missing json-serialize.js");JSON.SERIALIZE_VERSION!=="1.0.0"&&alert("json-serialize.js needs to be at version 1.0.0 or higher");LC||alert("Missing lifecycle.js");LC.VERSION!=="1.0.0"&&alert("lifecycle.js needs to be at version 1.0.0 or higher");this.Backbone.Articulation||(Backbone.Articulation={});Backbone.Articulation.VERSION="0.3.0";Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE=
!1;Backbone.Collection.prototype.toJSON=function(){for(var a=[],c=0,b=this.models.length;c<b;c++)a.push(this.models[c].toJSON());return a};Backbone.Collection.prototype.parse=function(a){if(!a||!_.isArray(a))return a;for(var c=[],b=0,d=a.length;b<d;b++)c.push(JSON.deserialize(a[b],{skip_type_field:!0}));return c};Backbone.Model.prototype.toJSON=function(){var a=JSON.serialize(this.attributes,{properties:!0});if(!a.hasOwnProperty(JSON.deserialize.TYPE_FIELD)){if(this.hasOwnProperty(JSON.deserialize.TYPE_FIELD))return a[JSON.deserialize.TYPE_FIELD]=
this[JSON.deserialize.TYPE_FIELD],a;var c=Object.getPrototypeOf(Object(this)).constructor.name;if(c)if(Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE){if(String.prototype.underscore){if(!String.prototype.singularize)throw Error("Missing String.prototype.singularize");}else throw Error("Missing String.prototype.underscore");a[JSON.deserialize.TYPE_FIELD]=c.underscore().singularize()}else a[JSON.deserialize.TYPE_FIELD]=c}return a};Backbone.Model.prototype.parse=function(a){return!a?a:JSON.deserialize(a,
{properties:!0,skip_type_field:!0})};Backbone.Model.prototype._ownAttribute=function(a,c){if(c)return c instanceof Backbone.Model||c instanceof Backbone.Collection?c:_.isArray(c)&&c.length&&(c[0]instanceof Backbone.Model||c[0]instanceof Backbone.Collection)?c:LC.own(c)};Backbone.Model.prototype._disownAttribute=function(a,c){if(c)return c instanceof Backbone.Model||c instanceof Backbone.Collection?c:_.isArray(c)&&c.length&&(c[0]instanceof Backbone.Model||c[0]instanceof Backbone.Collection)?c:LC.disown(c)};
var b=Backbone.Model.prototype.initialize;Backbone.Model.prototype.initialize=function(){var a=b.apply(this,arguments),c;for(c in this._previousAttributes)this._previousAttributes[c]=this._ownAttribute(c,this._previousAttributes[c]);return a};var a=Backbone.Model.prototype.set;Backbone.Model.prototype.set=function(b,c){if(!b)return this;if(b.attributes)b=b.attributes;for(var d in b)_.isEqual(this.attributes[d],b[d])||this._previousAttributes&&this._previousAttributes.hasOwnProperty(d)&&this._disownAttribute(d,
this._previousAttributes[d]);return a.apply(this,arguments)};var d=Backbone.Model.prototype.unset;Backbone.Model.prototype.unset=function(a,c){if(!(a in this.attributes))return this;this._disownAttribute(a,this.attributes[a]);return d.apply(this,arguments)};var e=Backbone.Model.prototype.clear;Backbone.Model.prototype.clear=function(a){for(var c in this.attributes)this._disownAttribute(c,this.attributes[c]);if(a&&a.silent)for(c in this._previousAttributes)this._disownAttribute(c,this._previousAttributes[c]);
return e.apply(this,arguments)};var g=Backbone.Model.prototype.change;Backbone.Model.prototype.change=function(a){for(var c in this._previousAttributes)this._disownAttribute(c,this._previousAttributes[c]);var b=g.apply(this,arguments);for(c in this._previousAttributes)this._previousAttributes[c]=this._ownAttribute(c,this._previousAttributes[c]);return b};var k=Backbone.Collection.prototype._reset;Backbone.Collection.prototype._reset=function(){this.models&&this.models.length&&(Backbone.Relational?
_.each(this.models,function(a){Backbone.Relational.store.unregister(a);a.clear({silent:!0})}):_.each(this.models,function(a){a.clear({silent:!0})}));return k.apply(this,arguments)};var f=Backbone.Collection.prototype._onModelEvent;Backbone.Collection.prototype._onModelEvent=function(a,c,b,d){if(a=="destroy"){for(var e in this._previousAttributes)this._disownAttribute(e,this._previousAttributes[e]);for(e in this.attributes)this._disownAttribute(e,this.attributes[e])}return f.apply(this,arguments)};
if(Backbone.RelationalModel)Backbone.RelationalModel.prototype.toJSON=function(){if(this.isLocked())return this.id;this.acquire();var a=Backbone.Model.prototype.toJSON.call(this);_.each(this._relations,function(c){var b=a[c.key];c.options.includeInJSON===!0&&b&&typeof b==="object"?a[c.key]=_.isFunction(b.toJSON)?b.toJSON():b:_.isString(c.options.includeInJSON)?b?b instanceof Backbone.Collection?a[c.key]=b.pluck(c.options.includeInJSON):b instanceof Backbone.Model?a[c.key]=b.get(c.options.includeInJSON):
_.isArray(b)?(a[c.key]=[],_.each(b,function(b){_.isUndefined(b)||a[c.key].push(b[c.options.includeInJSON])})):b instanceof Object&&(a[c.key]=b[c.options.includeInJSON]):a[c.key]=null:delete a[c.key]},this);this.release();return a}})();
