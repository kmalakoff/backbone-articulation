/*
  backbone-articulation.js 0.3.4
  (c) 2011, 2012 Kevin Malakoff - http://kmalakoff.github.com/backbone-articulation/
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Backbone.js, and Underscore.js.
*/(function(){return function(e){return typeof define=="function"&&define.amd?define("backbone-articulation",["underscore","backbone","json-serialize","lifecycle"],e):e.call(this)}(function(){var e,t,n,r={}.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};return n=!window._&&typeof require!="undefined"?require("underscore"):window._,n&&n.hasOwnProperty("_")&&(n=n._),t=!this.Backbone&&typeof require!="undefined"?require("backbone"):this.Backbone,e=!this.Backbone.Articulation&&typeof require!="undefined"?require("backbone-articulation"):this.Backbone.Articulation,typeof require!="undefined"&&require("backbone-relational"),typeof exports!="undefined"&&(module.exports=e),e.BackboneRelationalModel=t.RelationalModel.extend({toJSON:function(){var e,r,i,s,o,u,a,f,l,c;if(this.isLocked())return this.id;this.acquire(),r=this.__bba_toJSON?this.__bba_toJSON.call(this):function(){throw"Articulation.RelationalModel is not configured correctly"}(),c=this._relations;for(u=0,f=c.length;u<f;u++){s=c[u],o=r[s.key];if(s.options.includeInJSON===!0&&o&&typeof o=="object")r[s.key]=n.isFunction(o.toJSON)?o.toJSON():o;else if(n.isString(s.options.includeInJSON))if(!o)r[s.key]=null;else if(o instanceof t.Collection)r[s.key]=o.pluck(s.options.includeInJSON);else if(o instanceof t.Model)r[s.key]=o.get(s.options.includeInJSON);else if(n.isArray(o)){r[s.key]=[];for(e=a=0,l=o.length;a<l;e=++a)i=o[e],n.isUndefined(i)||r[s.key].push(i[s.options.includeInJSON])}else o instanceof Object&&(r[s.key]=o[s.options.includeInJSON]);else delete r[s.key]}return this.release(),r},_reset:function(){var e,t,n,r;if(this.models){r=this.models;for(t=0,n=r.length;t<n;t++)e=r[t],Relational.Relational.store.unregister(e)}return this.constructor.__super__.constructor.__super__._reset.apply(this,arguments)}}),e.Model.mixin(e.BackboneRelationalModel),e.BackboneRelationalCollection=function(t){function n(){return n.__super__.constructor.apply(this,arguments)}return i(n,t),n.prototype.model=e.BackboneRelationalModel,n}(e.Collection),t.Articulation})}).call(this);