// Backbone-Articulation.js 0.3.0
// (c) 2011 Kevin Malakoff.
// Backbone-Articulation may be freely distributed under the MIT license.
//
(function(){_||alert("Missing Underscore.js");Backbone||alert("Missing Backbone.js");JSON.SERIALIZE_VERSION||alert("Missing json-serialize.js");JSON.SERIALIZE_VERSION!=="1.1.0"&&alert("json-serialize.js needs to be at version 1.0.0 or higher");LC||alert("Missing lifecycle.js");LC.VERSION!=="1.0.0"&&alert("lifecycle.js needs to be at version 1.0.0 or higher");this.Backbone.Articulation||(Backbone.Articulation={});Backbone.Articulation.VERSION="0.3.0";Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE=
!1;Backbone.Collection.prototype.toJSON=function(){for(var b=[],a=0,c=this.models.length;a<c;a++)b.push(this.models[a].toJSON());return b};Backbone.Collection.prototype.parse=function(b){if(!b||!_.isArray(b))return b;for(var a=[],c=0,e=b.length;c<e;c++)a.push(JSON.deserialize(b[c],{skip_type_field:!0}));return a};Backbone.Model.prototype.toJSON=function(){var b=JSON.serialize(this.attributes,{properties:!0});if(!b.hasOwnProperty(JSON.deserialize.TYPE_FIELD)){if(this.hasOwnProperty(JSON.deserialize.TYPE_FIELD))return b[JSON.deserialize.TYPE_FIELD]=
this[JSON.deserialize.TYPE_FIELD],b;var a=Object.getPrototypeOf(Object(this)).constructor.name;if(a)if(Backbone.Articulation.TYPE_UNDERSCORE_SINGULARIZE){if(String.prototype.underscore){if(!String.prototype.singularize)throw Error("Missing String.prototype.singularize");}else throw Error("Missing String.prototype.underscore");b[JSON.deserialize.TYPE_FIELD]=a.underscore().singularize()}else b[JSON.deserialize.TYPE_FIELD]=a}return b};Backbone.Model.prototype.parse=function(b){return!b?b:JSON.deserialize(b,
{properties:!0,skip_type_field:!0})};Backbone.Model.prototype._ownAttribute=function(b,a){if(a)return a instanceof Backbone.Model||a instanceof Backbone.Collection?a:_.isArray(a)&&a.length&&(a[0]instanceof Backbone.Model||a[0]instanceof Backbone.Collection)?a:LC.own(a)};Backbone.Model.prototype._disownAttribute=function(b,a){if(a)return a instanceof Backbone.Model||a instanceof Backbone.Collection?a:_.isArray(a)&&a.length&&(a[0]instanceof Backbone.Model||a[0]instanceof Backbone.Collection)?a:LC.disown(a)};
var f=Backbone.Model.prototype.initialize;Backbone.Model.prototype.initialize=function(){var b=f.apply(this,arguments),a;for(a in this._previousAttributes)this._previousAttributes[a]=this._ownAttribute(a,this._previousAttributes[a]);return b};var g=Backbone.Model.prototype.set;Backbone.Model.prototype.set=function(b,a){if(!b)return this;if(b.attributes)b=b.attributes;for(var c in b)_.isEqual(this.attributes[c],b[c])||this._previousAttributes&&this._previousAttributes.hasOwnProperty(c)&&this._disownAttribute(c,
this._previousAttributes[c]);return g.apply(this,arguments)};var h=Backbone.Model.prototype.unset;Backbone.Model.prototype.unset=function(b,a){if(!(b in this.attributes))return this;this._disownAttribute(b,this.attributes[b]);return h.apply(this,arguments)};var i=Backbone.Model.prototype.clear;Backbone.Model.prototype.clear=function(b){for(var a in this.attributes)this._disownAttribute(a,this.attributes[a]);if(b&&b.silent)for(a in this._previousAttributes)this._disownAttribute(a,this._previousAttributes[a]);
return i.apply(this,arguments)};var j=Backbone.Model.prototype.change;Backbone.Model.prototype.change=function(b){for(var a in this._previousAttributes)this._disownAttribute(a,this._previousAttributes[a]);var c=j.apply(this,arguments);for(a in this._previousAttributes)this._previousAttributes[a]=this._ownAttribute(a,this._previousAttributes[a]);return c};var k=Backbone.Collection.prototype._reset;Backbone.Collection.prototype._reset=function(){this.models&&this.models.length&&(Backbone.Relational&&
this.models[0]instanceof Backbone.RelationalModel?_.each(this.models,function(b){Backbone.Relational.store.unregister(b);b.clear({silent:!0})}):_.each(this.models,function(b){b.clear({silent:!0})}));return k.apply(this,arguments)};var l=Backbone.Collection.prototype._onModelEvent;Backbone.Collection.prototype._onModelEvent=function(b,a,c,e){if(b=="destroy"){for(var d in this._previousAttributes)this._disownAttribute(d,this._previousAttributes[d]);for(d in this.attributes)this._disownAttribute(d,this.attributes[d])}return l.apply(this,
arguments)};if(Backbone.RelationalModel)Backbone.RelationalModel.prototype.toJSON=function(){if(this.isLocked())return this.id;this.acquire();var b=Backbone.Model.prototype.toJSON.call(this);_.each(this._relations,function(a){var c=b[a.key];a.options.includeInJSON===!0&&c&&typeof c==="object"?b[a.key]=_.isFunction(c.toJSON)?c.toJSON():c:_.isString(a.options.includeInJSON)?c?c instanceof Backbone.Collection?b[a.key]=c.pluck(a.options.includeInJSON):c instanceof Backbone.Model?b[a.key]=c.get(a.options.includeInJSON):
_.isArray(c)?(b[a.key]=[],_.each(c,function(c){_.isUndefined(c)||b[a.key].push(c[a.options.includeInJSON])})):c instanceof Object&&(b[a.key]=c[a.options.includeInJSON]):b[a.key]=null:delete b[a.key]},this);this.release();return b}})();
